<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>custos.</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #F7F4EF;
    --surface: #FFFFFF;
    --surface2: #F0EDE7;
    --border: #E2DDD6;
    --text: #1A1714;
    --muted: #8A847C;
    --accent: #C8522A;
    --accent-light: #F5E8E2;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 15px;
  }

header {
background: var(‚Äìtext);
color: white;
padding: 18px 20px;
display: flex;
align-items: center;
justify-content: space-between;
position: sticky;
top: 0;
z-index: 100;
}
.logo { font-family: ‚ÄòDM Serif Display‚Äô, serif; font-size: 22px; letter-spacing: -0.5px; }
.logo span { color: #C8A882; font-style: italic; }
.btn-icon {
background: rgba(255,255,255,0.1);
border: none; color: white;
width: 36px; height: 36px;
border-radius: 8px; cursor: pointer;
font-size: 15px;
display: flex; align-items: center; justify-content: center;
transition: background 0.2s;
}
.btn-icon:hover { background: rgba(255,255,255,0.2); }

main { max-width: 680px; margin: 0 auto; padding: 20px 16px 100px; }

.period-bar {
display: flex; align-items: center;
justify-content: space-between;
margin-bottom: 18px;
}
.period-nav { display: flex; align-items: center; gap: 12px; }
.period-nav button {
background: var(‚Äìsurface);
border: 1px solid var(‚Äìborder);
color: var(‚Äìtext);
width: 32px; height: 32px;
border-radius: 8px; cursor: pointer;
font-size: 14px;
display: flex; align-items: center; justify-content: center;
transition: all 0.15s;
}
.period-nav button:hover { background: var(‚Äìsurface2); }
.period-label { font-family: ‚ÄòDM Serif Display‚Äô, serif; font-size: 20px; letter-spacing: -0.3px; }
.view-toggle {
display: flex; gap: 3px;
background: var(‚Äìsurface2);
padding: 3px; border-radius: 8px;
}
.view-toggle button {
background: none; border: none; cursor: pointer;
padding: 5px 11px; border-radius: 6px;
font-size: 12px; font-family: ‚ÄòDM Sans‚Äô, sans-serif;
font-weight: 500; color: var(‚Äìmuted);
transition: all 0.15s;
}
.view-toggle button.active {
background: var(‚Äìsurface); color: var(‚Äìtext);
box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.summary-grid {
display: grid;
grid-template-columns: 1fr 1fr 1fr;
gap: 10px; margin-bottom: 18px;
}
.summary-card {
background: var(‚Äìsurface);
border-radius: 14px; padding: 14px 16px;
border: 1px solid var(‚Äìborder);
}
.summary-card.main-card {
background: var(‚Äìtext); color: white; border-color: var(‚Äìtext);
}
.card-label {
font-size: 10px; font-weight: 600;
text-transform: uppercase; letter-spacing: 0.8px;
color: var(‚Äìmuted); margin-bottom: 5px;
}
.main-card .card-label { color: #C8A882; }
.card-value { font-family: ‚ÄòDM Serif Display‚Äô, serif; font-size: 18px; letter-spacing: -0.5px; line-height: 1.2; }
.card-sub { font-size: 11px; color: var(‚Äìmuted); margin-top: 3px; }
.main-card .card-sub { color: rgba(255,255,255,0.45); }

.section-box {
background: var(‚Äìsurface);
border-radius: 16px; border: 1px solid var(‚Äìborder);
padding: 16px 18px; margin-bottom: 14px;
}
.section-title {
font-size: 11px; font-weight: 600;
text-transform: uppercase; letter-spacing: 0.8px;
color: var(‚Äìmuted); margin-bottom: 14px;
}
.cat-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.cat-row:last-child { margin-bottom: 0; }
.cat-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.cat-name { font-size: 13px; font-weight: 500; width: 105px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cat-bar-wrap { flex: 1; height: 6px; background: var(‚Äìsurface2); border-radius: 99px; overflow: hidden; }
.cat-bar { height: 100%; border-radius: 99px; transition: width 0.5s cubic-bezier(0.16,1,0.3,1); }
.cat-value { font-size: 13px; font-weight: 600; min-width: 78px; text-align: right; }

.entries-box {
background: var(‚Äìsurface);
border-radius: 16px; border: 1px solid var(‚Äìborder);
overflow: hidden; margin-bottom: 14px;
}
.entries-box-header {
padding: 14px 18px 12px;
border-bottom: 1px solid var(‚Äìborder);
}
.entry-item {
display: flex; align-items: center;
padding: 11px 18px; border-bottom: 1px solid var(‚Äìborder);
gap: 11px; transition: background 0.15s;
}
.entry-item:last-child { border-bottom: none; }
.entry-item:hover { background: var(‚Äìbg); }
.entry-badge {
width: 36px; height: 36px; border-radius: 10px;
display: flex; align-items: center; justify-content: center;
font-size: 16px; flex-shrink: 0;
}
.entry-info { flex: 1; min-width: 0; }
.entry-desc { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.entry-meta { font-size: 11px; color: var(‚Äìmuted); margin-top: 1px; }
.entry-val { font-family: ‚ÄòDM Serif Display‚Äô, serif; font-size: 16px; flex-shrink: 0; }
.entry-del {
background: none; border: none; color: var(‚Äìmuted);
cursor: pointer; font-size: 13px; opacity: 0;
transition: opacity 0.15s; padding: 4px; flex-shrink: 0;
}
.entry-item:hover .entry-del { opacity: 1; }
.entry-del:hover { color: var(‚Äìaccent); }

.empty-state { padding: 36px 20px; text-align: center; color: var(‚Äìmuted); }
.empty-state .ei { font-size: 32px; margin-bottom: 8px; }
.empty-state p { font-size: 13px; line-height: 1.6; }

.fab {
position: fixed; bottom: 24px; right: 20px;
background: var(‚Äìaccent); color: white;
border: none; width: 56px; height: 56px;
border-radius: 50%; font-size: 26px; cursor: pointer;
box-shadow: 0 4px 20px rgba(200,82,42,0.4);
display: flex; align-items: center; justify-content: center;
transition: transform 0.2s, box-shadow 0.2s; z-index: 50;
}
.fab:hover { transform: scale(1.06); box-shadow: 0 6px 28px rgba(200,82,42,0.5); }
.fab:active { transform: scale(0.95); }

.overlay {
position: fixed; inset: 0;
background: rgba(26,23,20,0.55);
backdrop-filter: blur(3px);
z-index: 200;
display: flex; align-items: flex-end; justify-content: center;
opacity: 0; pointer-events: none; transition: opacity 0.25s;
}
.overlay.open { opacity: 1; pointer-events: all; }
.modal {
background: var(‚Äìsurface);
border-radius: 20px 20px 0 0;
padding: 20px 20px 32px;
width: 100%; max-width: 680px;
transform: translateY(30px);
transition: transform 0.3s cubic-bezier(0.16,1,0.3,1);
max-height: 92vh; overflow-y: auto;
}
.overlay.open .modal { transform: translateY(0); }
.modal-handle {
width: 36px; height: 4px;
background: var(‚Äìborder); border-radius: 99px;
margin: 0 auto 18px;
}
.modal-title { font-family: ‚ÄòDM Serif Display‚Äô, serif; font-size: 22px; margin-bottom: 18px; }

.form-group { margin-bottom: 14px; }
.form-label {
font-size: 11px; font-weight: 600;
text-transform: uppercase; letter-spacing: 0.7px;
color: var(‚Äìmuted); margin-bottom: 6px; display: block;
}
.form-input {
width: 100%; padding: 12px 13px;
border: 1.5px solid var(‚Äìborder); border-radius: 10px;
font-size: 15px; font-family: ‚ÄòDM Sans‚Äô, sans-serif;
background: var(‚Äìbg); color: var(‚Äìtext);
transition: border-color 0.15s; outline: none;
-webkit-appearance: none; appearance: none;
}
.form-input:focus { border-color: var(‚Äìaccent); }

.cat-picker { display: grid; grid-template-columns: repeat(4, 1fr); gap: 7px; }
.cat-opt {
display: flex; flex-direction: column;
align-items: center; gap: 4px;
padding: 9px 4px; border-radius: 10px; cursor: pointer;
border: 1.5px solid var(‚Äìborder); background: var(‚Äìbg);
transition: all 0.15s;
font-size: 10px; font-weight: 500; color: var(‚Äìmuted); text-align: center;
}
.cat-opt .em { font-size: 19px; }
.cat-opt.selected { border-color: var(‚Äìaccent); background: var(‚Äìaccent-light); color: var(‚Äìaccent); }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.btn-save {
width: 100%; padding: 14px;
background: var(‚Äìtext); color: white; border: none;
border-radius: 12px; font-size: 15px; font-weight: 600;
font-family: ‚ÄòDM Sans‚Äô, sans-serif; cursor: pointer;
margin-top: 6px; transition: background 0.2s;
}
.btn-save:hover { background: #2e2a26; }
.btn-save:disabled { opacity: 0.5; cursor: not-allowed; }

.loading-screen {
position: fixed; inset: 0; background: var(‚Äìbg);
display: flex; align-items: center; justify-content: center;
flex-direction: column; gap: 14px; z-index: 999;
transition: opacity 0.4s;
}
.loading-screen.gone { opacity: 0; pointer-events: none; }
.loading-logo { font-family: ‚ÄòDM Serif Display‚Äô, serif; font-size: 28px; }
.loading-logo span { color: var(‚Äìaccent); font-style: italic; }
.spinner {
width: 26px; height: 26px;
border: 2.5px solid var(‚Äìborder);
border-top-color: var(‚Äìaccent);
border-radius: 50%;
animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-msg { font-size: 13px; color: var(‚Äìmuted); }

.toast {
position: fixed; bottom: 88px; left: 50%;
transform: translateX(-50%) translateY(8px);
background: var(‚Äìtext); color: white;
padding: 9px 18px; border-radius: 99px;
font-size: 13px; font-weight: 500;
opacity: 0; transition: all 0.28s;
pointer-events: none; white-space: nowrap; z-index: 400;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

.sync-pill {
display: flex; align-items: center; gap: 5px;
font-size: 11px; color: rgba(255,255,255,0.5);
}
.sync-dot {
width: 6px; height: 6px; border-radius: 50%;
background: #4CAF50;
animation: blink 2.5s infinite;
}
.sync-dot.busy {
background: transparent;
border: 2px solid #FFC107;
border-top-color: transparent;
border-radius: 50%;
width: 10px; height: 10px;
animation: spin 0.6s linear infinite;
}
.sync-dot.err { background: #f44336; animation: none; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }

@media (max-width: 460px) {
.summary-grid { grid-template-columns: 1fr 1fr; }
.summary-card:first-child { grid-column: 1 / -1; }
.cat-name { width: 80px; }
}
</style>

</head>
<body>

<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">custos<span>.</span></div>
  <div class="spinner"></div>
  <div class="loading-msg" id="loadingMsg">Conectando‚Ä¶</div>
</div>

<div class="toast" id="toast"></div>

<header>
  <div class="logo">custos<span>.</span></div>
  <div style="display:flex;gap:10px;align-items:center">
    <div class="sync-pill">
      <div class="sync-dot" id="syncDot"></div>
      <span id="syncLabel">Sincronizado</span>
    </div>
    <button class="btn-icon" id="exportBtn" title="Exportar CSV">‚¨á</button>
  </div>
</header>

<main>
  <div class="period-bar">
    <div class="period-nav">
      <button id="prevBtn">‚Üê</button>
      <span class="period-label" id="periodLabel">‚Äî</span>
      <button id="nextBtn">‚Üí</button>
    </div>
    <div class="view-toggle">
      <button class="active" id="btnLista" onclick="setView('lista')">Lista</button>
      <button id="btnCat" onclick="setView('categorias')">Categorias</button>
    </div>
  </div>

  <div class="summary-grid">
    <div class="summary-card main-card">
      <div class="card-label">Total do m√™s</div>
      <div class="card-value" id="cardTotal">R$ 0</div>
      <div class="card-sub" id="cardQtd">0 lan√ßamentos</div>
    </div>
    <div class="summary-card">
      <div class="card-label">Maior gasto</div>
      <div class="card-value" id="cardMaior">‚Äî</div>
      <div class="card-sub" id="cardMaiorDesc">‚Äî</div>
    </div>
    <div class="summary-card">
      <div class="card-label">M√©dia/dia</div>
      <div class="card-value" id="cardMedia">R$ 0</div>
      <div class="card-sub">neste m√™s</div>
    </div>
  </div>

  <div id="contentArea"></div>
</main>

<button class="fab" id="fabBtn">+</button>

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Novo lan√ßamento</div>

```
<div class="form-group">
  <label class="form-label">Categoria</label>
  <div class="cat-picker" id="catPicker"></div>
</div>

<div class="form-group">
  <label class="form-label">Descri√ß√£o</label>
  <input class="form-input" type="text" id="fDesc" placeholder="Ex: Conta de luz, Mercado‚Ä¶" autocomplete="off">
</div>

<div class="form-row">
  <div class="form-group">
    <label class="form-label">Valor (R$)</label>
    <input class="form-input" type="number" id="fValor" placeholder="0,00" step="0.01" min="0" inputmode="decimal">
  </div>
  <div class="form-group">
    <label class="form-label">Data</label>
    <input class="form-input" type="date" id="fData">
  </div>
</div>

<div class="form-group">
  <label class="form-label">Quem registrou</label>
  <input class="form-input" type="text" id="fPessoa" placeholder="Seu nome" autocomplete="off">
</div>

<button class="btn-save" id="btnSalvar">Salvar lan√ßamento</button>
```

  </div>
</div>

<script>
const API_KEY = '$2a$10$xx2oRBFprplf6Pr1KMJXsO.uMNy7UfOgsmXCeQffAazNfecRttOp6';
const BIN_NAME = 'custos-pessoais';
let BIN_ID = localStorage.getItem('custos_bin_id') || null;

const CATS = [
  { id:'moradia',     nome:'Moradia',     emoji:'üè†', color:'#4A6FA5' },
  { id:'alimentacao', nome:'Alimenta√ß√£o', emoji:'üõí', color:'#E07B39' },
  { id:'transporte',  nome:'Transporte',  emoji:'üöó', color:'#6B4FA5' },
  { id:'saude',       nome:'Sa√∫de',       emoji:'üíä', color:'#2A9D8F' },
  { id:'lazer',       nome:'Lazer',       emoji:'üé¨', color:'#C7A93B' },
  { id:'funcionaria', nome:'Funcion√°ria', emoji:'üë©‚Äçüç≥', color:'#E76F51' },
  { id:'outros',      nome:'Outros',      emoji:'üì¶', color:'#8A847C' },
];

let lancamentos = [];
let year, month, selCat = null, view = 'lista';

async function apiFetch(path, opts={}) {
  const res = await fetch('https://api.jsonbin.io/v3' + path, {
    ...opts,
    headers: {
      'Content-Type': 'application/json',
      'X-Master-Key': API_KEY,
      ...(opts.headers||{})
    }
  });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  return res.json();
}

async function loadOrCreate() {
  if (BIN_ID) {
    try {
      const d = await apiFetch('/b/' + BIN_ID + '/latest');
      lancamentos = d.record.lancamentos || [];
      return;
    } catch(e) {
      BIN_ID = null;
      localStorage.removeItem('custos_bin_id');
    }
  }
  const d = await apiFetch('/b', {
    method: 'POST',
    headers: { 'X-Bin-Name': BIN_NAME, 'X-Bin-Private': 'true' },
    body: JSON.stringify({ lancamentos: [] })
  });
  BIN_ID = d.metadata.id;
  localStorage.setItem('custos_bin_id', BIN_ID);
  lancamentos = [];
}

async function persist() {
  setSync('busy');
  try {
    await apiFetch('/b/' + BIN_ID, {
      method: 'PUT',
      body: JSON.stringify({ lancamentos })
    });
    setSync('ok');
  } catch(e) {
    setSync('err');
    showToast('Erro ao salvar ‚Äî verifique sua conex√£o');
    throw e;
  }
}

function setSync(s) {
  const dot = document.getElementById('syncDot');
  const lbl = document.getElementById('syncLabel');
  dot.className = 'sync-dot' + (s==='busy'?' busy': s==='err'?' err':'');
  lbl.textContent = s==='busy'?'Salvando‚Ä¶': s==='err'?'Erro':'Sincronizado';
}

(async () => {
  const now = new Date();
  year = now.getFullYear(); month = now.getMonth();
  buildCatPicker();
  document.getElementById('fData').value = now.toISOString().split('T')[0];
  const p = localStorage.getItem('custos_pessoa');
  if (p) document.getElementById('fPessoa').value = p;

  try {
    document.getElementById('loadingMsg').textContent = 'Carregando dados‚Ä¶';
    await loadOrCreate();
  } catch(e) {
    setSync('err');
    document.getElementById('loadingMsg').textContent = 'Erro de conex√£o';
    setTimeout(() => document.getElementById('loadingScreen').classList.add('gone'), 1500);
  }

  render();
  document.getElementById('loadingScreen').classList.add('gone');

  document.getElementById('fabBtn').onclick = openModal;
  document.getElementById('overlay').onclick = e => { if(e.target===e.currentTarget) closeModal(); };
  document.getElementById('btnSalvar').onclick = salvar;
  document.getElementById('prevBtn').onclick = () => changeMonth(-1);
  document.getElementById('nextBtn').onclick = () => changeMonth(1);
  document.getElementById('exportBtn').onclick = exportCSV;
})();

function render() {
  updatePeriod();
  const items = getFiltered();
  updateSummary(items);
  view==='lista' ? renderLista(items) : renderCats(items);
}

function getFiltered() {
  return lancamentos
    .filter(l => { const d=new Date(l.data+'T12:00:00'); return d.getFullYear()===year&&d.getMonth()===month; })
    .sort((a,b) => new Date(b.data)-new Date(a.data));
}

function updatePeriod() {
  const M=['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  document.getElementById('periodLabel').textContent = M[month]+' '+year;
}

function updateSummary(items) {
  const total = items.reduce((s,l)=>s+l.valor,0);
  document.getElementById('cardTotal').textContent = fmt(total);
  document.getElementById('cardQtd').textContent = items.length+' lan√ßamento'+(items.length!==1?'s':'');
  if (items.length) {
    const m = items.reduce((mx,l)=>l.valor>mx.valor?l:mx);
    const c = CATS.find(c=>c.id===m.categoria);
    document.getElementById('cardMaior').textContent = fmt(m.valor);
    document.getElementById('cardMaiorDesc').textContent = c?c.nome:'Outros';
  } else {
    document.getElementById('cardMaior').textContent='‚Äî';
    document.getElementById('cardMaiorDesc').textContent='‚Äî';
  }
  const days = new Date(year,month+1,0).getDate();
  const now = new Date();
  const elapsed = (year===now.getFullYear()&&month===now.getMonth())?now.getDate():days;
  document.getElementById('cardMedia').textContent = elapsed?fmt(total/elapsed):'R$ 0';
}

function renderLista(items) {
  const el = document.getElementById('contentArea');
  if (!items.length) {
    el.innerHTML='<div class="entries-box"><div class="empty-state"><div class="ei">üìã</div><p>Nenhum lan√ßamento neste m√™s.<br>Toque no + para adicionar.</p></div></div>';
    return;
  }
  el.innerHTML = '<div class="entries-box"><div class="entries-box-header"><span class="section-title">Lan√ßamentos</span></div>'
    + items.map(l => {
        const c=CATS.find(c=>c.id===l.categoria)||CATS[6];
        const ds=new Date(l.data+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'short'});
        return `<div class="entry-item">
          <div class="entry-badge" style="background:${c.color}22">${c.emoji}</div>
          <div class="entry-info">
            <div class="entry-desc">${esc(l.descricao)}</div>
            <div class="entry-meta">${c.nome} ¬∑ ${ds}${l.pessoa?' ¬∑ '+esc(l.pessoa):''}</div>
          </div>
          <div class="entry-val">${fmt(l.valor)}</div>
          <button class="entry-del" onclick="deletar('${l.id}')">‚úï</button>
        </div>`;
      }).join('')
    + '</div>';
}

function renderCats(items) {
  const el = document.getElementById('contentArea');
  const total = items.reduce((s,l)=>s+l.valor,0);
  const byCat={};
  CATS.forEach(c=>byCat[c.id]=0);
  items.forEach(l=>{ if(byCat[l.categoria]!==undefined)byCat[l.categoria]+=l.valor; else byCat['outros']+=l.valor; });
  const sorted = CATS.map(c=>({...c,total:byCat[c.id]||0})).filter(c=>c.total>0).sort((a,b)=>b.total-a.total);
  if (!sorted.length) {
    el.innerHTML='<div class="section-box"><div class="empty-state"><div class="ei">üìä</div><p>Sem dados neste m√™s ainda.</p></div></div>';
    return;
  }
  el.innerHTML = '<div class="section-box"><div class="section-title">Por categoria</div>'
    + sorted.map(c=>{
        const pct=total>0?c.total/total*100:0;
        return `<div class="cat-row">
          <div class="cat-dot" style="background:${c.color}"></div>
          <div class="cat-name">${c.emoji} ${c.nome}</div>
          <div class="cat-bar-wrap"><div class="cat-bar" style="width:${pct}%;background:${c.color}"></div></div>
          <div class="cat-value">${fmt(c.total)}</div>
        </div>`;
      }).join('')
    + '</div>';
}

async function salvar() {
  const desc=document.getElementById('fDesc').value.trim();
  const valor=parseFloat(document.getElementById('fValor').value);
  const data=document.getElementById('fData').value;
  const pessoa=document.getElementById('fPessoa').value.trim();
  if (!selCat){showToast('Escolha uma categoria');return;}
  if (!desc){showToast('Informe a descri√ß√£o');return;}
  if (!valor||valor<=0){showToast('Informe um valor v√°lido');return;}
  if (!data){showToast('Informe a data');return;}
  if (pessoa) localStorage.setItem('custos_pessoa',pessoa);
  const btn=document.getElementById('btnSalvar');
  btn.disabled=true; btn.textContent='Salvando‚Ä¶';
  lancamentos.push({id:Date.now().toString(),categoria:selCat,descricao:desc,valor,data,pessoa,criadoEm:new Date().toISOString()});
  try {
    await persist();
    closeModal(); render(); showToast('Lan√ßamento salvo ‚úì');
    document.getElementById('fDesc').value='';
    document.getElementById('fValor').value='';
    document.getElementById('fData').value=new Date().toISOString().split('T')[0];
    selCat=null;
    document.querySelectorAll('.cat-opt').forEach(e=>e.classList.remove('selected'));
  } catch(e) {
    lancamentos.pop();
  }
  btn.disabled=false; btn.textContent='Salvar lan√ßamento';
}

async function deletar(id) {
  if (!confirm('Excluir este lan√ßamento?')) return;
  const prev=[...lancamentos];
  lancamentos=lancamentos.filter(l=>l.id!==id);
  try { await persist(); render(); showToast('Lan√ßamento exclu√≠do'); }
  catch(e) { lancamentos=prev; render(); }
}

function changeMonth(d) {
  month+=d;
  if(month>11){month=0;year++;}
  if(month<0){month=11;year--;}
  render();
}

function setView(v) {
  view=v;
  document.getElementById('btnLista').classList.toggle('active',v==='lista');
  document.getElementById('btnCat').classList.toggle('active',v==='categorias');
  render();
}

function exportCSV() {
  const items=getFiltered();
  if(!items.length){showToast('Sem dados para exportar');return;}
  const rows=[['Data','Categoria','Descri√ß√£o','Valor (R$)','Quem']];
  items.forEach(l=>{const c=CATS.find(c=>c.id===l.categoria);rows.push([l.data,c?c.nome:l.categoria,l.descricao,l.valor.toFixed(2),l.pessoa||'']);});
  const csv=rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'}));
  const M=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  a.download='custos_'+M[month]+'_'+year+'.csv';
  a.click();
  showToast('CSV exportado ‚úì');
}

function openModal(){document.getElementById('overlay').classList.add('open');document.getElementById('fDesc').focus();}
function closeModal(){document.getElementById('overlay').classList.remove('open');}

function buildCatPicker(){
  document.getElementById('catPicker').innerHTML=CATS.map(c=>`<div class="cat-opt" data-id="${c.id}" onclick="selectCat('${c.id}')"><span class="em">${c.emoji}</span><span>${c.nome}</span></div>`).join('');
}

function selectCat(id){
  selCat=id;
  document.querySelectorAll('.cat-opt').forEach(e=>e.classList.toggle('selected',e.dataset.id===id));
}

function fmt(v){return 'R$ '+v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2600);}
</script>

</body>
</html>
